#!/bin/env bash
# (C) 2014-2022 - supaplextor cloned/exported code to https://github.com/supaplextor/rsyncplan
# (C) 2014 Scott Edwards - https://code.google.com/p/rsyncplan/

# ops="--delete-excluded --timeout=120 --exclude=*.config/google-chrome/Default/* --delete-after -4iSvPaXAplx --bwlimit=1500"

ops="--rsync-path=/usr/local/sbin/rsyncplan-exechook.sh \
	--delete-excluded --timeout=120 \
	--exclude=/swapfile \
	--delete-after -4iSvPaXAplx"

me=`hostname`
remotehost=nas
doRemoteLinks=true

TIMESTAMP_YMDHMS_NS=$(date "+%Y-%m-%d_%H%M%S.%N")

ifs=/
OFS=/backups/${me}/rootfs

# rootfs is an alias for /
if [ Xrootfs = X$ifs ]
then
	ifs=/
fi

if ${doRemoteLinks} 
then
links=$(ssh "${remotehost}" ls -1d "${OFS}/????-??-??*/" 2>/dev/null |\
	grep -v "${TIMESTAMP_YMDHMS_NS}" |\
	sort -nr |\
	head -n 20 |\
	awk '{print "--link-dest=__OFS__/"$1"/"}' |\
	sed -e "s#__OFS__##g" | tr -s /
	)
fi

rsync $ops $links $ifs "${remotehost}":"${OFS}/${TIMESTAMP_YMDHMS_NS}/"
